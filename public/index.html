<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPG-SGBD Dashboard</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #0a0a0f, #1a1c24);
      --glass: rgba(255, 255, 255, 0.08);
      --accent: #00b4d8;
      --accent-glow: 0 0 15px #00b4d8aa;
      --text: #f8f9fa;
      --muted: #9da3b0;
      --danger: #ff4d6d;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins",sans-serif; }
    body {
      background: var(--bg); color: var(--text);
      min-height: 100vh; display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    h1 { font-size: 2rem; margin-bottom: .5rem; text-shadow: var(--accent-glow); }
    #game-container {
      display:flex; flex-direction:column; width:92%; max-width:1000px; height:92vh;
      background:var(--glass); border:1px solid rgba(255,255,255,.12); border-radius:20px;
      backdrop-filter: blur(10px); box-shadow:0 0 30px rgba(0,0,0,.6); padding:16px 22px;
    }
    #top {
      display:flex; gap:18px; align-items:flex-start; justify-content:space-between;
    }
    .panel {
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      border-radius:14px; padding:12px 14px;
    }
    #statusBox { flex:2; }
    #mapBox { flex:1; display:flex; flex-direction:column; align-items:center; gap:8px; }
    #hp-bars { display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:8px; }
    .hpwrap { width:100%; }
    .hplabel { display:flex; justify-content:space-between; font-size:.9rem; color:var(--muted); margin-bottom:6px; }
    .hpbar { width:100%; height:20px; background:#333; border-radius:10px; overflow:hidden; }
    .hpfill { height:100%; width:100%; background:linear-gradient(90deg, #00ff87, #60efff); transition: width .35s; }
    .hpfill.monstro { background: linear-gradient(90deg, #ff8fa3, #ffccd5); }
    #map-grid {
      display:grid; grid-template-columns: repeat(5, 22px); grid-template-rows:repeat(5, 22px);
      gap:5px; justify-content:center;
    }
    .map-cell { width:22px; height:22px; background:rgba(255,255,255,.1); border-radius:4px; }
    .visited { background: rgba(0, 180, 216, .35); }
    .player { background: var(--accent); box-shadow: var(--accent-glow); }
    #movement {
      display:grid; grid-template-columns:80px 80px 80px; grid-template-rows:80px 80px 80px;
      gap:10px; justify-content:center; align-items:center; margin: 14px 0;
    }
    #movement button, #actions button {
      border:none; border-radius:12px; background:var(--accent); color:#000; font-weight:700; cursor:pointer;
      transition: all .2s; box-shadow: var(--accent-glow);
    }
    #movement button { width:80px; height:80px; font-size:1.5rem; }
    #movement button:hover, #actions button:hover { background:#00e1ff; transform: scale(1.07); }
    #movement div { width:80px; height:80px; visibility:hidden; }
    #actions { display:flex; gap:12px; }
    #actions button { padding:.8rem 1.3rem; font-size:1rem; }
    #infoRow { display:flex; gap:18px; margin-top:8px; }
    #battleInfo { flex:1; }
    #inventory { flex:1; }
    #log { margin-top:12px; background:rgba(0,0,0,.5); width:100%; height:180px; overflow-y:auto; padding:10px; border-radius:10px; font-size:.92rem; color:var(--muted); }
    @media (max-width: 720px) {
      #top { flex-direction:column; }
      #hp-bars { grid-template-columns: 1fr; }
      #movement button, #movement div { width:60px; height:60px; }
      #map-grid { grid-template-columns: repeat(5, 18px); grid-template-rows:repeat(5, 18px); gap:4px; }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h1>üéÆ RPG-SGBD Dashboard</h1>

    <div id="top">
      <div id="statusBox" class="panel">
        <div><strong>Status</strong> ‚Äî <span id="battleFlag">Em batalha: N√£o</span> ‚Äî <span id="pos">Posi√ß√£o: (0, 0)</span></div>
        <div id="hp-bars">
          <div class="hpwrap">
            <div class="hplabel"><span>HP Jogador</span><span id="hpPlayerText">100 / 100</span></div>
            <div class="hpbar"><div id="hpPlayerFill" class="hpfill"></div></div>
          </div>
          <div class="hpwrap">
            <div class="hplabel"><span>HP Monstro</span><span id="hpMonsterText">100 / 100</span></div>
            <div class="hpbar"><div id="hpMonsterFill" class="hpfill monstro"></div></div>
          </div>
        </div>
      </div>

      <div id="mapBox" class="panel">
        <div><strong>Mini-mapa</strong></div>
        <div id="map-grid"></div>
      </div>
    </div>

    <!-- Dire√ß√µes -->
    <div id="movement">
      <div></div>
      <button id="btnUp">‚Üë</button>
      <div></div>
      <button id="btnLeft">‚Üê</button>
      <button id="btnDown">‚Üì</button>
      <button id="btnRight">‚Üí</button>
      <div></div><div></div><div></div>
    </div>

    <!-- A√ß√µes -->
    <div id="actions">
      <button id="btnAttack">‚öîÔ∏è Atacar</button>
      <button id="btnBlock">üõ°Ô∏è Bloquear</button>
      <button id="btnHeal">üíä Curar</button>
      <button id="btnRefresh">üîÑ Atualizar Status</button>
    </div>

    <div id="infoRow">
      <div id="battleInfo" class="panel">
        <strong>Ambiente</strong>
        <div id="ambient">‚Äî</div>
      </div>
      <div id="inventory" class="panel">
        <strong>Invent√°rio</strong>
        <ul id="invList" style="margin-top:6px;"></ul>
      </div>
    </div>

    <div id="log" class="panel">üìú Aguardando a√ß√µes‚Ä¶</div>
  </div>

  <script>
    const logDiv = document.getElementById("log");
    const hpPF = document.getElementById("hpPlayerFill");
    const hpMF = document.getElementById("hpMonsterFill");
    const hpPT = document.getElementById("hpPlayerText");
    const hpMT = document.getElementById("hpMonsterText");
    const posSpan = document.getElementById("pos");
    const ambient = document.getElementById("ambient");
    const battleFlag = document.getElementById("battleFlag");
    const invList = document.getElementById("invList");
    const mapGrid = document.getElementById("map-grid");

    let sessionId = null;
    let posX = 0, posY = 0;

    const BASES = [window.location.origin, "http://localhost:10000"];
    async function apiFetch(path, options = {}) {
      let lastErr;
      for (const base of BASES) {
        try {
          const res = await fetch(`${base}${path}`, options);
          if (!res.ok) throw new Error(res.statusText);
          return res;
        } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error("API indispon√≠vel");
    }

    function log(t) {
      logDiv.innerHTML += `<div>${t}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function setHPBars(hpP, hpM) {
      hpPF.style.width = `${Math.max(0, Math.min(100, hpP))}%`;
      hpMF.style.width = `${Math.max(0, Math.min(100, hpM))}%`;
      hpPT.textContent = `${hpP} / 100`;
      hpMT.textContent = `${hpM} / 100`;
    }

    // ----- Mini-mapa -----
    function initMap() {
      mapGrid.innerHTML = "";
      for (let i = 0; i < 25; i++) {
        const cell = document.createElement("div");
        cell.className = "map-cell";
        mapGrid.appendChild(cell);
      }
      updateMap();
    }
    function updateMap() {
      const cells = document.querySelectorAll(".map-cell");
      cells.forEach(c => c.className = "map-cell visited");
      const idx = posY * 5 + posX;
      if (cells[idx]) cells[idx].classList.add("player");
      posSpan.textContent = `Posi√ß√£o: (${posX}, ${posY})`;
    }

    async function carregarInventario() {
      if (!sessionId) return;
      const res = await apiFetch(`/inventario?session_id=${sessionId}`);
      const data = await res.json();
      invList.innerHTML = "";
      if (data.sucesso && data.itens.length) {
        data.itens.forEach(i => {
          const li = document.createElement("li");
          li.textContent = `‚Ä¢ ${i.nome} ‚Äî ${i.quantidade}`;
          invList.appendChild(li);
        });
      } else {
        invList.innerHTML = "<li>‚Äî vazio ‚Äî</li>";
      }
    }

    async function atualizarStatus() {
      if (!sessionId) return;
      const res = await apiFetch(`/status?session_id=${sessionId}`);
      const data = await res.json();
      if (data.sucesso) {
        setHPBars(data.hp_personagem, data.hp_monstro);
        battleFlag.textContent = `Em batalha: ${data.em_batalha ? "Sim" : "N√£o"}`;
        posX = data.pos_x; posY = data.pos_y;
        updateMap();
      }
    }

    async function novaSessao() {
      try {
        const res = await apiFetch("/nova-sessao", { method: "POST" });
        const data = await res.json();
        if (data.sucesso) {
          sessionId = data.sessionId;
          posX = 0; posY = 0;
          initMap();
          await atualizarStatus();
          await carregarInventario();
          log("‚úÖ Nova sess√£o iniciada!");
        } else {
          log("‚ùå Erro ao iniciar sess√£o: " + (data.erro || "desconhecido"));
        }
      } catch (e) {
        log("üö´ Falha ao conectar ao servidor: " + e.message);
      }
    }

    async function explorar(dir) {
      if (!sessionId) return log("‚ö†Ô∏è Nenhuma sess√£o ativa.");
      const res = await apiFetch(`/explorar?session_id=${sessionId}&direcao=${dir}`);
      const data = await res.json();
      if (data.sucesso) {
        posX = data.pos_x ?? posX;
        posY = data.pos_y ?? posY;
        updateMap();
        ambient.textContent = data.descricao || "‚Äî";
        log(`‚û°Ô∏è ${data.descricao}`);
        if (data.loot) {
          await carregarInventario();
        }
        if (data.monstro) {
          await atualizarStatus(); // hp_monstro volta a 100
        }
      } else {
        log(`‚ùå ${data.erro}`);
      }
    }

    async function acao(tipo) {
      if (!sessionId) return log("‚ö†Ô∏è Nenhuma sess√£o ativa.");
      const res = await apiFetch("/acao", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, personagemId: 1, acao: tipo }),
      });
      const data = await res.json();
      if (data.sucesso) {
        if (data.jogador) log(`üßô ${data.jogador}`);
        if (data.monstro) log(`üëπ ${data.monstro}`);
        setHPBars(data.hp_personagem, data.hp_monstro);
        battleFlag.textContent = `Em batalha: ${data.em_batalha ? "Sim" : "N√£o"}`;
        await carregarInventario();
      } else {
        log(`‚ùå ${data.erro}`);
      }
    }

    // Controles
    document.getElementById("btnUp").onclick = () => explorar("up");
    document.getElementById("btnDown").onclick = () => explorar("down");
    document.getElementById("btnLeft").onclick = () => explorar("left");
    document.getElementById("btnRight").onclick = () => explorar("right");
    document.getElementById("btnAttack").onclick = () => acao("atacar");
    document.getElementById("btnBlock").onclick  = () => acao("bloquear");
    document.getElementById("btnHeal").onclick   = () => acao("curar");
    document.getElementById("btnRefresh").onclick = () => { atualizarStatus(); carregarInventario(); };

    // Inicializa√ß√£o
    novaSessao();
  </script>
</body>
</html>
